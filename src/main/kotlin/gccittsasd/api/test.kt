import io.github.cdimascio.dotenv.dotenv
import io.ktor.client.*
import io.ktor.client.call.*
import io.ktor.client.engine.cio.*
import io.ktor.client.request.*
import java.security.KeyFactory
import java.security.KeyPairGenerator
import java.security.MessageDigest
import java.security.SecureRandom
import java.security.spec.X509EncodedKeySpec
import java.util.Base64
import javax.crypto.Cipher

fun String.sha256(): String {
    return hashString(this, "SHA-256")
}

private fun hashString(input: String, algorithm: String): String {
    return MessageDigest
        .getInstance(algorithm)
        .digest(input.toByteArray())
        .fold("") { str, it -> str + "%02x".format(it) }
}

suspend fun main() {
    val keyRes = HttpClient(CIO).get("http://localhost:8080/key")
    val spec = X509EncodedKeySpec(Base64.getDecoder().decode(keyRes.body<String>()))
    val key = KeyFactory.getInstance("RSA").generatePublic(spec)
    val cipher = Cipher.getInstance("RSA/ECB/PKCS1Padding")
    cipher.init(Cipher.ENCRYPT_MODE, key)

    // account creation
//    val create = HttpClient(CIO).post("http://localhost:8080/accounts/create") {
//        setBody("{\"username\": \"admin\", \"password\": \"${Base64.getEncoder().encodeToString(cipher.doFinal("${"password".sha256()}:ID=${SecureRandom().nextFloat().toString().sha256()}".toByteArray()))}\"}")
//    }
//    println(create.status)

    // account login
    val generator = KeyPairGenerator.getInstance("RSA")
    generator.initialize(2048, SecureRandom())
    val keyPair = generator.genKeyPair()
    val decrypt = Cipher.getInstance("RSA/ECB/PKCS1Padding")
    decrypt.init(Cipher.DECRYPT_MODE, keyPair.private)

    val login = HttpClient(CIO).post("http://localhost:8080/accounts/login") {
        setBody("{\"username\": \"admin\", \"password\": \"${Base64.getEncoder().encodeToString(cipher.doFinal("${"password".sha256()}:ID=${SecureRandom().nextFloat().toString().sha256()}".toByteArray()))}\", \"key\": \"${Base64.getEncoder().encodeToString(keyPair.public.encoded)}\"}")
    }

    var token: String? = null
    if (login.status.value == 200) token = String(decrypt.doFinal(Base64.getDecoder().decode(login.body<String>())))
    println(token)

    // account logout
//    val logout = HttpClient(CIO).post("http://localhost:8080/accounts/logout") {
//        setBody("{\"token\": \"${Base64.getEncoder().encodeToString(cipher.doFinal("$token:ID=${SecureRandom().nextFloat().toString().sha256()}".toByteArray()))}\"}")
//    }
//    println(logout.status)

    // account deletion
//    val identifier = SecureRandom().nextFloat().toString().sha256()
//    val delete = HttpClient(CIO).post("http://localhost:8080/accounts/delete") {
//        setBody("{\"token\": \"${Base64.getEncoder().encodeToString(cipher.doFinal("$token:ID=$identifier".toByteArray()))}\", \"password\":  \"${Base64.getEncoder().encodeToString(cipher.doFinal("${"password".sha256()}:ID=$identifier".toByteArray()))}\"}")
//    }
//    println(delete.status)

    // send in a file
    val identifier = SecureRandom().nextFloat().toString().sha256()
    val fileSent = HttpClient(CIO).post("http://localhost:8080/exchange/send") {
        setBody("{\"token\": \"${
                Base64.getEncoder().encodeToString(
                    cipher.doFinal(
                        "$token:ID=${identifier}".toByteArray()
                    )
                )
            }\", \"file\": \"+ASwBBgBVASwBBgBuASwBBgCLASwBBgCqASwBBgDDASwBBgDeASwBBgD5ASwBBgAxAhICBgBFAhICBgBTAiwBBgBsAiwBBgCcAokCRwCwAgAABgDfAr8CBgD/Ar8CBgAsA6gABgBMA6gABgCCA2QDBgCqA5ADBgC9A5ADBgDOA2QDBgDeA5ADBgDwA2QDBgD8A2QDAAAAAAEAAAAAAAEAAQABABAAHQA1AAUAAQABAIEBAABZADUABQABAAMAVoCeAA4AEQC/AFwAUCAAAAAAhhiQAAoAAQBdIAAAAADmAZYACgABAGQgAAAAAJEYxQBgAAEAcCAAAAAAlgDMAGAAAQCoIAAAAACWANoAYAABALQgAAAAAJEA6ABkAAEAAgAJACEAkABpACkAkABpADEAkABpADkAkABpAEEAkABpAEkAkABpAFEAkABpAFkAkABpAGEAkABpAGkAkABuAHEAkABpAHkAkABpAIEAkABpAIkAkABzAJkAkAB5AKEAkAAKAAkAkAAKAKkANwN+ABkAPwMKALkAkAAKAMEAkACCANEAkACKALkADgSUABkAkACaAA4ABAARAC4ACwCqAC4AEwD0AC4AGwD0AC4AIwAIAS4AKwAIAS4AMwAOAS4AOwAoAS4AQwAIAS4AUwAIAS4AWwBUAS4AawB+AS4AcwCMAS4AewCVAS4AgwCeAaQABIAAAAMAIwAAAAMAAAAAAAAAHQMAAAQAAAAAAAAAAAAAAAEAbQAAAAAAAAAAAAA8TW9kdWxlPgBDb3JzYWlyLlB1YmxpYy5kbGwAQ29yc2FpckRldmljZXNHdWFyZExvY2sAQ29yc2Fpckxpbms0LlB1YmxpYy5TeW5jaHJvbml6YXRpb24AQ29yc2FpckRldmljZXNHdWFyZABtc2NvcmxpYgBTeXN0ZW0AT2JqZWN0AElEaXNwb3NhYmxlAC5jdG9yAERpc3Bvc2UATXV0ZXhOYW1lAFN5c3RlbS5UaHJlYWRpbmcATXV0ZXgAbXV0ZXgALmNjdG9yAEFjcXVpcmVEZXZpY2UAUmVsZWFzZURldmljZQBDcmVhdGVHdWFyZE11dGV4AFN5c3RlbS5SdW50aW1lLlZlcnNpb25pbmcAVGFyZ2V0RnJhbWV3b3JrQXR0cmlidXRlAFN5c3RlbS5SZWZsZWN0aW9uAEFzc2VtYmx5VGl0bGVBdHRyaWJ1dGUAQXNzZW1ibHlQcm9kdWN0QXR0cmlidXRlAEFzc2VtYmx5RGVzY3JpcHRpb25BdHRyaWJ1dGUAQXNzZW1ibHlDb25maWd1cmF0aW9uQXR0cmlidXRlAEFzc2VtYmx5Q29tcGFueUF0dHJpYnV0ZQBBc3NlbWJseUNvcHlyaWdodEF0dHJpYnV0ZQBBc3NlbWJseVRyYWRlbWFya0F0dHJpYnV0ZQBBc3NlbWJseUN1bHR1cmVBdHRyaWJ1dGUAU3lzdGVtLlJ1bnRpbWUuSW50ZXJvcFNlcnZpY2VzAENvbVZpc2libGVBdHRyaWJ1dGUAR3VpZEF0dHJpYnV0ZQBBc3NlbWJseVZlcnNpb25BdHRyaWJ1dGUAQXNzZW1ibHlGaWxlVmVyc2lvbkF0dHJpYnV0ZQBTeXN0ZW0uRGlhZ25vc3RpY3MARGVidWdnYWJsZUF0dHJpYnV0ZQBEZWJ1Z2dpbmdNb2RlcwBTeXN0ZW0uUnVudGltZS5Db21waWxlclNlcnZpY2VzAENvbXBpbGF0aW9uUmVsYXhhdGlvbnNBdHRyaWJ1dGUAUnVudGltZUNvbXBhdGliaWxpdHlBdHRyaWJ1dGUAQ29yc2Fpci5QdWJsaWMAV2FpdEhhbmRsZQBXYWl0T25lAFJlbGVhc2VNdXRleABBYmFuZG9uZWRNdXRleEV4Y2VwdGlvbgBTeXN0ZW0uU2VjdXJpdHkuQWNjZXNzQ29udHJvbABNdXRleFNlY3VyaXR5AFN5c3RlbS5TZWN1cml0eS5QcmluY2lwYWwAU2VjdXJpdHlJZGVudGlmaWVyAFdlbGxLbm93blNpZFR5cGUATXV0ZXhBY2Nlc3NSdWxlAElkZW50aXR5UmVmZXJlbmNlAE11dGV4UmlnaHRzAEFjY2Vzc0NvbnRyb2xUeXBlAEFkZEFjY2Vzc1J1bGUAAEtHAGwAbwBiAGEAbABcAEMAbwByAHMAYQBpAHIATABpAG4AawBSAGUAYQBkAFcAcgBpAHQAZQBHAHUAYQByAGQATQB1AHQAZQB4AAAAAACZxdCr4W8aSrn99mczAAq2AAi3elxWGTTgiQMgAAECBg5KRwBsAG8AYgBhAGwAXABDAG8AcgBzAGEAaQByAEwAaQBuAGsAUgBlAGEAZABXAHIAaQB0AGUARwB1AGEAcgB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\"}")
    }
    println(fileSent.status)

    // receive a file
    val receive = HttpClient(CIO).post("http://localhost:8080/exchange/receive") {
        setBody("{\"token\": \"${Base64.getEncoder().encodeToString(cipher.doFinal("$token:ID=${SecureRandom().nextFloat().toString().sha256()}".toByteArray()))}\", \"load\": 10, \"memory\": 8000000000}")
    }
    println(receive.body<String>())
}